variables:
  SECURITY_SCANNER: "/opt/devsecops/scripts/security_scanner.sh"
  REPORT_DIR: "reports"

stages:
  - security

security_scan:
  stage: security
  image: docker:dind
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script: 
    - mkdir -p reports
    - chmod 777 reports
    - apk add --no-cache bash findutils coreutils python3 py3-pip curl openjdk11 unzip gcc python3-dev musl-dev linux-headers
    - pip3 install --break-system-packages bandit safety
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.48.0
    - mkdir -p /opt/dependency-check
    - curl -L "https://github.com/jeremylong/DependencyCheck/releases/download/v7.1.1/dependency-check-7.1.1-release.zip" -o /opt/dependency-check/dc.zip
    - cd /opt/dependency-check && unzip dc.zip && rm dc.zip
    - ln -s /opt/dependency-check/dependency-check/bin/dependency-check.sh /usr/local/bin/dependency-check
    - chmod +x /usr/local/bin/dependency-check
    - cd $CI_PROJECT_DIR
  script:
    - bash $SECURITY_SCANNER .
    - ls -la reports/
    - find . -name "*summary.md"
  artifacts:
    paths:
      - reports/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: reports/security_scan_${CI_JOB_ID}_summary.md
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
